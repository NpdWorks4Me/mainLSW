name: Vercel Debug

on:
  workflow_dispatch:

jobs:
  list-projects:
    runs-on: ubuntu-latest
    steps:
      - name: Show environment
        run: |
          echo "VERCEL_ORG_ID=${VERCEL_ORG_ID:-<not-set>}"
          echo "VERCEL_PROJECT_ID=${VERCEL_PROJECT_ID:-<not-set>}"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Query Vercel projects (team/org)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          set -euo pipefail
          echo 'Fetching projects for VERCEL_ORG_ID=' "$VERCEL_ORG_ID"
          STATUS=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VERCEL_TOKEN" "https://api.vercel.com/v1/projects?teamId=$VERCEL_ORG_ID" -o /tmp/vercel_projects.json)
          echo "HTTP status: $STATUS"
          echo "Raw response (first 10 lines):"
          head -n 10 /tmp/vercel_projects.json || true
          echo 'Attempting to parse projects using jq (handles array or object shapes)'
          # Use try to avoid "Cannot index array with string" errors when response is an array
          cat /tmp/vercel_projects.json | jq 'try (.projects // .) catch . | if (type=="array" or type=="object") then (if type=="array" then .[] else . end) else empty end | {id: .id, name: .name, alias: (if .alias then (.alias | map(.alias // .)) else [] end), git: (if .gitRepository then .gitRepository elif (.repo and .repo.full_name) then .repo.full_name else null end)}'
