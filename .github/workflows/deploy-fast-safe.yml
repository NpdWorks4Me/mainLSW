name: Fast Deploy to Hostinger (safe)

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-and-deploy:
    name: Build and Deploy (fast safe)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build main site
        run: npm run build:main

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

      - name: Install lftp (fallback)
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Pre-deploy: quick validate SSH host & key (fast)
        if: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY != '' }}
        env:
          HOSTINGER_SSH_HOST: ${{ secrets.HOSTINGER_SSH_HOST }}
          HOSTINGER_SSH_PRIVATE_KEY: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
          HOSTINGER_SSH_PORT: ${{ secrets.HOSTINGER_SSH_PORT || 22 }}
        run: |
          echo "Validating HOSTINGER_SSH_HOST format and DNS (fast-safe)"
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^https?://"; then echo "HOST contains protocol (https://) please remove protocol and use host only"; exit 1; fi
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^.+/.+"; then echo "HOST contains path info; use host only (no path)"; exit 1; fi
          if [ -z "${HOSTINGER_SSH_HOST}" ]; then echo "HOSTINGER_SSH_HOST is missing"; exit 1; fi
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$"; then
            echo "Host is IP â€” checking TCP port ${HOSTINGER_SSH_PORT}"
            nc -vz -w 5 ${HOSTINGER_SSH_HOST} ${HOSTINGER_SSH_PORT} || { echo "TCP connection to ${HOSTINGER_SSH_HOST}:${HOSTINGER_SSH_PORT} failed"; exit 1; }
          else
            if command -v dig >/dev/null 2>&1; then
              dig +short "${HOSTINGER_SSH_HOST}" | sed -n '1p' >/tmp/_dig_addr || true
              if [ ! -s /tmp/_dig_addr ]; then echo "dig returned no A record for ${HOSTINGER_SSH_HOST}"; nslookup "${HOSTINGER_SSH_HOST}" || { echo "DNS lookup failed (NXDOMAIN) - please verify the host is correct and publicly resolvable"; exit 1; }; fi
            else
              nslookup "${HOSTINGER_SSH_HOST}" || { echo "DNS lookup failed (NXDOMAIN) - please verify the host is correct and publicly resolvable"; exit 1; }
            fi
          fi
          echo "Validating PRIVATE KEY format"
          if [ -z "${HOSTINGER_SSH_PRIVATE_KEY}" ]; then echo "HOSTINGER_SSH_PRIVATE_KEY missing"; exit 1; fi
          printf "%s\n" "${HOSTINGER_SSH_PRIVATE_KEY}" > /tmp/hostinger_key
          chmod 600 /tmp/hostinger_key
          ssh-keygen -y -f /tmp/hostinger_key >/tmp/_hostinger_pub || { echo "ssh-keygen parse failed (invalid private key)"; exit 1; }
          echo "Pre-deploy SSH host & key validation succeeded (fast-safe)"

      

      - name: Deploy via SFTP (attempt)
        # intentionally run for testing (do not break on missing secrets)
        if: always()
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOSTINGER_SSH_HOST }}
          username: ${{ secrets.HOSTINGER_SSH_USERNAME }}
          key: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
          port: ${{ secrets.HOSTINGER_SSH_PORT || 22 }}
          source: "dist/"
          target: "${{ secrets.HOSTINGER_TARGET_DIR_MAIN || 'public_html' }}"

      - name: Deploy via FTP (fallback attempt)
        if: always()
        env:
          FTP_HOST: ${{ secrets.HOSTINGER_FTP_HOST }}
          FTP_USER: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.HOSTINGER_FTP_PORT || 21 }}
          FTP_DIR: ${{ secrets.HOSTINGER_TARGET_DIR_MAIN || 'public_html' }}
        run: |
          echo "Attempting FTP fallback (may fail if secrets missing)"
          lftp -u "$FTP_USER","$FTP_PASS" -p $FTP_PORT $FTP_HOST -e "mirror -R --delete --verbose dist $FTP_DIR; quit" || true

      - name: Quick verify
        if: always()
        env:
          SITE_URL: ${{ secrets.HOSTINGER_SITE_URL }}
        run: |
          echo "Waiting for site to be ready..."
          sleep 5
          curl -I "$SITE_URL" || true
