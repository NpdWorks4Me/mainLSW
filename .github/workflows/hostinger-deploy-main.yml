name: Build, Test, and Deploy to Hostinger (main only)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  preflight:
    name: Preflight (debug)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Preflight echo
        run: |
          echo "Preflight debug for hostinger-deploy-main"
          echo "branch: $GITHUB_REF"
          echo "sha: $GITHUB_SHA"

  secret-check:
    name: Secret check (report missing secrets)
    runs-on: ubuntu-latest
    steps:
      - name: Check and report secrets
        id: check
        run: |
          set -euo pipefail
          MISSING=0
          REPORT=secrets-report.txt
          echo "Secret check report" > $REPORT
          check() {
            name="$1"
            val="$2"
            if [ -n "$val" ]; then
              echo "OK: $name" | tee -a $REPORT
            else
              echo "MISSING: $name" | tee -a $REPORT
              MISSING=$((MISSING+1))
            fi
          }
          check "HOSTINGER_SSH_HOST" "${HOSTINGER_SSH_HOST:-}"
          check "HOSTINGER_SSH_USERNAME" "${HOSTINGER_SSH_USERNAME:-}"
          check "HOSTINGER_SSH_PRIVATE_KEY" "${HOSTINGER_SSH_PRIVATE_KEY:-}"
          check "HOSTINGER_FTP_HOST" "${HOSTINGER_FTP_HOST:-}"
          check "HOSTINGER_FTP_USERNAME" "${HOSTINGER_FTP_USERNAME:-}"
          check "HOSTINGER_FTP_PASSWORD" "${HOSTINGER_FTP_PASSWORD:-}"
          check "HOSTINGER_SITE_URL" "${HOSTINGER_SITE_URL:-}"
          check "VITE_SUPABASE_URL" "${VITE_SUPABASE_URL:-}"
          check "VITE_SUPABASE_ANON_KEY" "${VITE_SUPABASE_ANON_KEY:-}"
          check "SUPABASE_DB_URL" "${SUPABASE_DB_URL:-}"
          check "HOSTINGER_API_TOKEN" "${HOSTINGER_API_TOKEN:-}"
          check "HOSTINGER_SITE_ID" "${HOSTINGER_SITE_ID:-}"
          echo "missing_count=$MISSING" >> $GITHUB_OUTPUT
        env:
          HOSTINGER_SSH_HOST: ${{ secrets.HOSTINGER_SSH_HOST }}
          HOSTINGER_SSH_USERNAME: ${{ secrets.HOSTINGER_SSH_USERNAME }}
          HOSTINGER_SSH_PRIVATE_KEY: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
          HOSTINGER_FTP_HOST: ${{ secrets.HOSTINGER_FTP_HOST }}
          HOSTINGER_FTP_USERNAME: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          HOSTINGER_FTP_PASSWORD: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          HOSTINGER_SITE_URL: ${{ secrets.HOSTINGER_SITE_URL }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          HOSTINGER_API_TOKEN: ${{ secrets.HOSTINGER_API_TOKEN }}
          HOSTINGER_SITE_ID: ${{ secrets.HOSTINGER_SITE_ID }}

      - name: Upload secrets report
        uses: actions/upload-artifact@v4
        with:
          name: secrets-report
          path: secrets-report.txt

  build-and-test:
    name: Build and Test (main)
    runs-on: ubuntu-latest
    needs: [preflight, secret-check]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build main site
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
        run: npm run build:main

      - name: Validate main build is not admin (pre-deploy check)
        run: npm run check:predeploy

      - name: Ensure no admin artifacts are present in dist
        run: npm run check:dist-no-admin

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright main store test
        run: npx playwright test -c playwright.main.config.js tests/store.spec.js --project=chromium --reporter=html

      - name: Verify games routes for regressions
        run: npm run check:snake-route

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

      - name: Upload main artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  migrate-supabase:
    name: Apply Supabase migrations
    runs-on: ubuntu-latest
    needs: build-and-test
    if: ${{ secrets.SUPABASE_DB_URL != '' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install psql client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Apply SQL migrations to Supabase (safe run)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          set -euo pipefail
          echo "Applying migrations from supabase/migrations to $SUPABASE_DB_URL"
          for f in supabase/migrations/*.sql; do
            echo "Applying $f"
            psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 -f "$f"
          done

  deploy:
    name: Deploy to Hostinger
    runs-on: ubuntu-latest
    needs: [build-and-test, migrate-supabase]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download main artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Install lftp (for FTP fallback)
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Pre-deploy: validate SSH host & key
        if: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY != '' }}
        env:
          HOSTINGER_SSH_HOST: ${{ secrets.HOSTINGER_SSH_HOST }}
          HOSTINGER_SSH_PRIVATE_KEY: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
          HOSTINGER_SSH_PORT: ${{ secrets.HOSTINGER_SSH_PORT || 22 }}
        run: |
          echo "Validating HOSTINGER_SSH_HOST format and DNS"
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^https?://"; then echo "HOST contains protocol (https://) please remove protocol and use host only"; exit 1; fi
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^.+/.+"; then echo "HOST contains path info; use host only (no path)"; exit 1; fi
          if [ -z "${HOSTINGER_SSH_HOST}" ]; then echo "HOSTINGER_SSH_HOST is missing"; exit 1; fi
          # If host is IP address: check TCP connect. Otherwise check DNS resolution.
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$"; then
            echo "HOST is IP, validating TCP connect to ${HOSTINGER_SSH_HOST}:${HOSTINGER_SSH_PORT}"
            nc -vz -w 5 "${HOSTINGER_SSH_HOST}" "${HOSTINGER_SSH_PORT}" || { echo "TCP connection failed"; exit 1; }
          else
            if command -v dig >/dev/null 2>&1; then
              dig +short "${HOSTINGER_SSH_HOST}" | sed -n '1p' >/tmp/_dig_addr || true
              if [ ! -s /tmp/_dig_addr ]; then echo "dig returned no A record for ${HOSTINGER_SSH_HOST}"; nslookup "${HOSTINGER_SSH_HOST}" || { echo "DNS lookup failed (NXDOMAIN) - please verify the host is correct and publicly resolvable"; exit 1; }; fi
            else
              nslookup "${HOSTINGER_SSH_HOST}" || { echo "DNS lookup failed (NXDOMAIN) - please verify the host is correct and publicly resolvable"; exit 1; }
            fi
          fi
          echo "Validating PRIVATE KEY format"
          if [ -z "${HOSTINGER_SSH_PRIVATE_KEY}" ]; then echo "HOSTINGER_SSH_PRIVATE_KEY missing"; exit 1; fi
          printf "%s\n" "${HOSTINGER_SSH_PRIVATE_KEY}" > /tmp/hostinger_key
          chmod 600 /tmp/hostinger_key
          ssh-keygen -y -f /tmp/hostinger_key >/tmp/_hostinger_pub || { echo "ssh-keygen parse failed (invalid private key)"; exit 1; }
          echo "Pre-deploy SSH host & key validation succeeded"

      - name: Deploy main via SFTP
        if: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY != '' }}
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOSTINGER_SSH_HOST }}
          username: ${{ secrets.HOSTINGER_SSH_USERNAME }}
          key: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
          port: ${{ secrets.HOSTINGER_SSH_PORT || 22 }}
          source: "dist/"
          target: "${{ secrets.HOSTINGER_TARGET_DIR_MAIN || 'public_html' }}"

      - name: Deploy main via FTP (fallback)
        if: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY == '' && secrets.HOSTINGER_FTP_HOST != '' }}
        env:
          FTP_HOST: ${{ secrets.HOSTINGER_FTP_HOST }}
          FTP_USER: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          FTP_PASS: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.HOSTINGER_FTP_PORT || 21 }}
          FTP_DIR: ${{ secrets.HOSTINGER_TARGET_DIR_MAIN || 'public_html' }}
        run: |
          lftp -u "$FTP_USER","$FTP_PASS" -p $FTP_PORT $FTP_HOST -e "mirror -R --delete --verbose dist $FTP_DIR; quit"

      - name: Verify deployment
        if: ${{ secrets.HOSTINGER_SITE_URL != '' }}
        env:
          SITE_URL: ${{ secrets.HOSTINGER_SITE_URL }}
        run: |
          echo "Waiting for site to be ready..."
          sleep 5
          curl -I "$SITE_URL" || true

      - name: Optionally update Hostinger site environment via API
        if: ${{ secrets.HOSTINGER_API_TOKEN != '' && secrets.HOSTINGER_SITE_ID != '' }}
        env:
          HOSTINGER_API_TOKEN: ${{ secrets.HOSTINGER_API_TOKEN }}
          HOSTINGER_SITE_ID: ${{ secrets.HOSTINGER_SITE_ID }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
        run: |
          echo 'Updating Hostinger site env via the hostinger API (if available)';
          node ./scripts/set-hostinger-env.js --site $HOSTINGER_SITE_ID --token $HOSTINGER_API_TOKEN --vars "STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY,STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET,NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" --api-url "https://api.hostinger.com/v1/sites/$HOSTINGER_SITE_ID/env" --method PATCH || true
