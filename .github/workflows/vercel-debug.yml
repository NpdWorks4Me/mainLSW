name: Vercel Debug

on:
  workflow_dispatch:

jobs:
  list-projects:
    runs-on: ubuntu-latest
    steps:
      - name: Show environment
        run: |
          echo "VERCEL_ORG_ID=${VERCEL_ORG_ID:-<not-set>}"
          echo "VERCEL_PROJECT_ID=${VERCEL_PROJECT_ID:-<not-set>}"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Query Vercel projects (team/org)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          set -euo pipefail
          echo 'Fetching projects for VERCEL_ORG_ID=' "$VERCEL_ORG_ID"
          STATUS=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VERCEL_TOKEN" "https://api.vercel.com/v1/projects?teamId=$VERCEL_ORG_ID" -o /tmp/vercel_projects.json)
          echo "HTTP status: $STATUS"
          echo "Raw response (first 10 lines):"
          head -n 10 /tmp/vercel_projects.json || true
          echo 'Attempting to parse projects using jq (handles array or object shapes)'
          # Use try to avoid "Cannot index array with string" errors when response is an array
          echo 'Printing a compact per-project mapping (id, name, aliases)'
          cat /tmp/vercel_projects.json | jq -c 'try (.projects // .) catch . | (if type=="array" then .[] else . end) | {id: .id, name: .name, aliases: (.alias // [] | map(.alias // .))}' | sed -n '1,200p'

      - name: NOTE - SSO protected projects
        run: |
          echo "If your project is SSO-protected, add a repository secret named VERCEL_SSO_BYPASS_TOKEN with an SSO bypass token to allow CI smoke tests to verify page content."
          echo "To discover canonical project id (prj_...) rerun this workflow, then update VERCEL_PROJECT_ID in repo secrets to the id printed above."
