name: Debug Hostinger SSH Connection

on:
  workflow_dispatch:
    inputs:
      force_ftp:
        description: 'If true, also check FTP host diagnostics'
        required: false

jobs:
  ssh-diagnostics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run SSH/host diagnostics
        id: diag
        env:
          HOSTINGER_SSH_HOST: ${{ secrets.HOSTINGER_SSH_HOST }}
          HOSTINGER_SSH_USERNAME: ${{ secrets.HOSTINGER_SSH_USERNAME }}
          HOSTINGER_SSH_PORT: ${{ secrets.HOSTINGER_SSH_PORT }}
          HOSTINGER_SSH_PRIVATE_KEY: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
          HOSTINGER_FTP_HOST: ${{ secrets.HOSTINGER_FTP_HOST }}
        run: |
          set -euo pipefail
          OUT=ssh-diagnostics.txt
          echo "SSH diagnostics run: $(date --utc)" > $OUT
          echo "HOSTINGER_SSH_HOST set: ${HOSTINGER_SSH_HOST:+yes}" >> $OUT
          echo "HOSTINGER_SSH_USERNAME set: ${HOSTINGER_SSH_USERNAME:+yes}" >> $OUT
          echo "HOSTINGER_SSH_PORT set: ${HOSTINGER_SSH_PORT:+yes}" >> $OUT

          if [ -z "${HOSTINGER_SSH_HOST:-}" ]; then
            echo "HOSTINGER_SSH_HOST is empty; cannot perform DNS check" >> $OUT
          else
            echo "--- DNS (dig +short) for SSH host ${HOSTINGER_SSH_HOST} ---" >> $OUT
            if command -v dig >/dev/null 2>&1; then
              dig +short "${HOSTINGER_SSH_HOST}" >> $OUT || true
            else
              nslookup "${HOSTINGER_SSH_HOST}" >> $OUT || true
            fi
            echo "--- getent ahosts ---" >> $OUT
            getent ahosts "${HOSTINGER_SSH_HOST}" >> $OUT || true
            echo "--- TCP test to SSH port ---" >> $OUT
            nc -vz -w 5 "${HOSTINGER_SSH_HOST}" "${HOSTINGER_SSH_PORT:-22}" >> $OUT 2>&1 || true
          fi

          if [ -n "${HOSTINGER_SSH_PRIVATE_KEY:-}" ]; then
            echo "--- Private key parse test (ssh-keygen -y) ---" >> $OUT
            printf "%s" "${HOSTINGER_SSH_PRIVATE_KEY}" > /tmp/hostinger_key
            chmod 600 /tmp/hostinger_key
            if ssh-keygen -y -f /tmp/hostinger_key >/tmp/_pub 2>/tmp/_err; then
              echo "Private key is parseable (ssh-keygen -y succeeded)" >> $OUT
            else
              echo "Private key parse failed; ssh-keygen output:" >> $OUT
              sed -n '1,200p' /tmp/_err >> $OUT || true
            fi
          else
            echo "No HOSTINGER_SSH_PRIVATE_KEY set; skipping key parse" >> $OUT
          fi

          if [ "${{ github.event.inputs.force_ftp || 'false' }}" = "true" ]; then
            echo "--- FTP host diagnostics ---" >> $OUT
            if [ -n "${HOSTINGER_FTP_HOST:-}" ]; then
              if command -v dig >/dev/null 2>&1; then
                dig +short "${HOSTINGER_FTP_HOST}" >> $OUT || true
              else
                nslookup "${HOSTINGER_FTP_HOST}" >> $OUT || true
              fi
              nc -vz -w 5 "${HOSTINGER_FTP_HOST}" 21 >> $OUT 2>&1 || true
            else
              echo "HOSTINGER_FTP_HOST not set" >> $OUT
            fi
          fi
          echo "Diagnostics written to $OUT"

      - name: Upload diagnostics artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh-diagnostics
          path: ssh-diagnostics.txt
