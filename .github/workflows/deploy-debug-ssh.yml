name: Debug Hostinger SSH Connection

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ssh-debug:
    runs-on: ubuntu-latest
    env:
      HOSTINGER_SSH_HOST: ${{ secrets.HOSTINGER_SSH_HOST }}
      HOSTINGER_SSH_USERNAME: ${{ secrets.HOSTINGER_SSH_USERNAME }}
      HOSTINGER_SSH_PRIVATE_KEY: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
      HOSTINGER_SSH_PORT: ${{ secrets.HOSTINGER_SSH_PORT || 22 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight info
        run: |
          echo "Starting SSH debug (Host will be printed masked)"
          echo "HOST (masked): ${HOSTINGER_SSH_HOST}"

      - name: Validate DNS resolution / reachability
        run: |
          echo "Checking HOSTINGER_SSH_HOST format"
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^https?://"; then echo "HOST contains protocol (https://) please remove protocol and use host only"; exit 1; fi
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^.+/.+"; then echo "HOST contains path info; use host only (no path)"; exit 1; fi
          if [ -z "${HOSTINGER_SSH_HOST}" ]; then echo "HOSTINGER_SSH_HOST is missing"; exit 1; fi
          echo "Lookup host: ${HOSTINGER_SSH_HOST}"
          # If the host looks like an IP address, check with TCP connect. If a hostname, check DNS resolution.
          if printf "%s" "${HOSTINGER_SSH_HOST}" | grep -qE "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$"; then
            echo "Host appears to be an IP address; checking TCP connectivity to ${HOSTINGER_SSH_HOST}:${HOSTINGER_SSH_PORT}"
            nc -vz -w 5 ${HOSTINGER_SSH_HOST} ${HOSTINGER_SSH_PORT} || { echo "TCP connection to ${HOSTINGER_SSH_HOST}:${HOSTINGER_SSH_PORT} failed"; exit 1; }
          else
            # Prefer dig to get A records, but fallback to nslookup if dig isn't available
            if command -v dig >/dev/null 2>&1; then
              dig +short "${HOSTINGER_SSH_HOST}" | sed -n '1p' >/tmp/_dig_addr || true
              if [ ! -s /tmp/_dig_addr ]; then echo "dig returned no A record for ${HOSTINGER_SSH_HOST}"; nslookup "${HOSTINGER_SSH_HOST}" || { echo "DNS lookup failed (NXDOMAIN or no A record)"; exit 1; }; fi
            else
              nslookup "${HOSTINGER_SSH_HOST}" || { echo "DNS lookup failed (NXDOMAIN or no A record)"; exit 1; }
            fi
          fi

      - name: Validate SSH key parse
        env:
          HOSTINGER_SSH_PRIVATE_KEY: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
        run: |
          if [ -z "${HOSTINGER_SSH_PRIVATE_KEY}" ]; then echo "HOSTINGER_SSH_PRIVATE_KEY missing"; exit 1; fi
          printf "%s\n" "${HOSTINGER_SSH_PRIVATE_KEY}" > /tmp/hostinger_key
          chmod 600 /tmp/hostinger_key
          echo "Testing private key format with ssh-keygen -y (does NOT print the key)"
          ssh-keygen -y -f /tmp/hostinger_key >/tmp/_hostinger_pub || { echo "ssh-keygen parse failed (invalid private key)"; exit 1; }
          echo "Private key parsed OK (public key generated)"

      - name: Test SSH connectivity
        env:
          HOST: ${{ secrets.HOSTINGER_SSH_HOST }}
          USER: ${{ secrets.HOSTINGER_SSH_USERNAME }}
          PORT: ${{ secrets.HOSTINGER_SSH_PORT || 22 }}
        run: |
          echo "Attempting TCP connect to ${HOST}:${PORT} (no key shown)"
          nc -vz -w 5 ${HOST} ${PORT} || { echo "TCP port open failed"; exit 1; }
          echo "Now attempting SSH nondestructive connect (will not run commands)"
          ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i /tmp/hostinger_key ${USER}@${HOST} -p ${PORT} echo "SSH_OK" || { echo "SSH connection failed (auth or host)"; exit 1; }

      - name: Result summary
        run: |
          echo "SSH debug completed (success)"
